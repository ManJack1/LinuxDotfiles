if(!window.injectionWatch){window.injectionWatch=!0;const e=({single:e,langCode:t,langName:n,dubbing:i,voiceCode:o,voiceName:s,position:a,openSubtitle:r,autoPlay:l,quality:c,qualityLock:d},p)=>{const u=p?"#player":"#ytd-player",y=document.querySelector(u),m=y.querySelector(".ytp-settings-menu"),g=(y.querySelector(".ytp-right-controls"),m.querySelector(".ytp-panel")),v=g.querySelector(".ytp-panel-menu"),w=y.querySelector(".ytp-settings-button"),b=chrome.i18n.getMessage;if(m.addEventListener("click",(e=>e.stopPropagation())),v.insertAdjacentHTML("beforeend",`\n      <div class="ytp-menuitem" style="display: none;" role="menuitem" aria-haspopup="true" tabindex="0" id="language-button">\n        <div class="ytp-menuitem-icon">\n        ${p?"":'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path\n          d="M12.7909 14.8818L10.4818 12.6L10.5091 12.5727C12.0909 10.8091 13.2182 8.78182 13.8818 6.63636H16.5455V4.81818H10.1818V3H8.36364V4.81818H2V6.62727H12.1545C11.5455 8.38182 10.5818 10.0455 9.27273 11.5C8.42727 10.5636 7.72727 9.53636 7.17273 8.45455H5.35455C6.01818 9.93636 6.92727 11.3364 8.06364 12.6L3.43636 17.1636L4.72727 18.4545L9.27273 13.9091L12.1 16.7364L12.7909 14.8818ZM17.9091 10.2727H16.0909L12 21.1818H13.8182L14.8364 18.4545H19.1545L20.1818 21.1818H22L17.9091 10.2727ZM15.5273 16.6364L17 12.7L18.4727 16.6364H15.5273Z"\n          fill="white"\n          stroke-width="0.3"\n          stroke="#000"\n        />\n        </svg>'}\n        </div>\n        <div class="ytp-menuitem-label">${b("defaultSubtitles")}</div>\n        <div class="ytp-menuitem-content">${n}</div>\n      </div>\n      <div class="ytp-menuitem" style="display: none;" role="menuitemcheckbox" aria-checked="${e}" tabindex="0" id="single-button">\n        <div class="ytp-menuitem-icon">\n        ${p?"":'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path\n          d="M20.2727 4H4.72727C3.77727 4 3 4.77727 3 5.72727V17.8182C3 18.7682 3.77727 19.5455 4.72727 19.5455H20.2727C21.2227 19.5455 22 18.7682 22 17.8182V5.72727C22 4.77727 21.2227 4 20.2727 4ZM20.2727 17.8182H4.72727V5.72727H20.2727V17.8182ZM6.45455 14.3636H18.5455V16.9545H6.45455V14.3636Z"\n          fill="white"\n          stroke-width="0.3"\n          stroke="#000"\n        />\n        </svg>'}\n        </div>\n        <div class="ytp-menuitem-label">${b("singleSubtitle")}</div>\n        <div class="ytp-menuitem-content"><div class="ytp-menuitem-toggle-checkbox"></div></div>\n      </div>\n      <div class="ytp-menuitem" style="display: none;" role="menuitem" aria-haspopup="true" tabindex="0" id="subtitle-download">\n        <div class="ytp-menuitem-icon">\n        ${p?"":'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path\n          d="M20 9.42857H15.7143V3H9.28571V9.42857H5L12.5 16.9286L20 9.42857ZM11.4286 11.5714V5.14286H13.5714V11.5714H14.825L12.5 13.8964L10.175 11.5714H11.4286ZM5 19.0714H20V21.2143H5V19.0714Z"\n          fill="white"\n          stroke-width="0.4"\n          stroke="#000"\n        />\n        </svg>'}\n        </div>\n        <div class="ytp-menuitem-label">${b("subtitleDownload")}</div>\n        <div class="ytp-menuitem-content"></div>\n      </div>\n      <div class="ytp-menuitem" style="display: none;" role="menuitem" aria-haspopup="true" tabindex="0" id="dubbing-settings">\n        <div class="ytp-menuitem-icon"></div>\n        <div class="ytp-menuitem-label">${b("dubbingSettings")}</div>\n        <div class="ytp-menuitem-content">${s}</div>\n      </div>\n      `),!n){const e=({data:i})=>{if("web"===i.source&&"responseTranslationList"===i.type&&i.text){const{languageName:o=""}=i.text.find((({languageCode:e})=>t===e))||{};v.querySelector("#language-button .ytp-menuitem-content").textContent=o,chrome.storage.sync.set({langName:o}),w.removeEventListener("click",n),window.removeEventListener("message",e)}},n=()=>{window.postMessage({source:"ext",type:"requestTranslationList"}),window.addEventListener("message",e)};w.addEventListener("click",n)}w.addEventListener("mouseenter",(()=>{const e=y.querySelector(".video-ads.ytp-ad-module .ytp-ad-player-overlay");y.querySelector(".ytp-subtitles-button").hasAttribute("aria-pressed")&&!e?chrome.storage.sync.get(["hideDownload","dubbing","single","langName"],(({hideDownload:e,dubbing:t,single:n,langName:i})=>{const o=v.querySelector("#subtitle-download"),s=v.querySelector("#dubbing-settings");["#language-button","#single-button"].forEach((e=>v.querySelector(e).style.removeProperty("display"))),e?o.style.setProperty("display","none"):o.style.removeProperty("display"),t?s.style.removeProperty("display"):s.style.setProperty("display","none"),v.querySelector("#single-button").setAttribute("aria-checked",n),v.querySelector("#language-button .ytp-menuitem-content").textContent=i})):["#language-button","#single-button","#subtitle-download","#dubbing-settings"].forEach((e=>v.querySelector(e).style.setProperty("display","none")))})),v.querySelector("#single-button").addEventListener("click",(function(){chrome.storage.sync.get("single",(({single:e})=>{e=!e,this.setAttribute("aria-checked",e),chrome.storage.sync.set({single:e}),window.postMessage({source:"ext",type:"restartSubtitles",text:e})}))}));const h=()=>{["click","blur"].forEach((e=>window.removeEventListener(e,h))),setTimeout((()=>{const e=m.querySelector("#forward");e&&e.remove(),g.classList.remove("ytp-panel-animate-back"),m.style.removeProperty("min-height"),m.style.removeProperty("max-width")}),200)},f=(e,t,n)=>{let i="min-height";m.style.getPropertyValue("height")===`${e}px`&&(m.style.removeProperty("min-height"),i="height"),m.style.removeProperty("max-width"),m.classList.add("ytp-popup-animating"),m.style.setProperty(i,t),[m,g].forEach((e=>e.style.setProperty("width",`${v.offsetWidth}px`))),m.querySelector("#forward").classList.add("ytp-panel-animate-forward"),g.classList.remove("ytp-panel-animate-back"),setTimeout((()=>{m.classList.remove("ytp-popup-animating"),m.style.removeProperty("min-height"),m.querySelector("#forward").remove(),n&&n()}),280)},L=(e,t)=>{setTimeout((()=>{m.classList.add("ytp-popup-animating"),m.style.setProperty("height",`${e}px`);const t=m.querySelector("#forward").offsetWidth;m.style.setProperty("width",`${t}px`),g.classList.add("ytp-panel-animate-back"),m.querySelector("#forward").classList.remove("ytp-panel-animate-forward"),setTimeout((()=>{m.classList.remove("ytp-popup-animating"),m.style.setProperty("min-height",`${e}px`),m.style.setProperty("max-width",`${t}px`),["click","blur"].forEach((e=>window.addEventListener(e,h,{once:!0}))),[...v.children].forEach((e=>e.style.setProperty("white-space","nowrap")))}),280)}),10),[".ytp-button",".ytp-panel-title"].forEach((n=>{m.querySelector(`#forward .ytp-panel-header ${n}`).addEventListener("click",(()=>f(e,t)),{once:!0})}))};v.querySelector("#language-button").addEventListener("click",(()=>{chrome.storage.sync.get(["langCode","recentLang"],(({langCode:e,recentLang:t})=>{const n=m.style.getPropertyValue("height");let i=Math.round(.7*y.querySelector(".html5-video-player").offsetHeight);i>416&&(i=416),window.postMessage({source:"ext",type:"requestTranslationList"});const o=({data:s})=>{if("web"===s.source&&"responseTranslationList"===s.type){window.removeEventListener("message",o);let a=[];const r=s.text.reduce(((n,{languageCode:i,languageName:o})=>{const s=t.indexOf(i);return-1!==s?(a[s]=`\n                <div class="ytp-menuitem" role="menuitemradio" ${e===i?'aria-checked="true"':""}>\n                  <div class="ytp-menuitem-label" data-lang="${i}">${o}</div>\n                </div>`,n):n.concat(`<div class="ytp-menuitem" role="menuitemradio">\n                      <div class="ytp-menuitem-label" data-lang="${i}">${o}</div>\n                    </div>`)}),[]),l=a.concat(r).join("");m.insertAdjacentHTML("beforeend",`<div class="ytp-panel ytp-panel-animate-forward" id="forward" style="min-width: 250px; height: ${i}px;">\n                <div class="ytp-panel-header">\n                  <div class="ytp-panel-back-button-container">\n                    <button class="ytp-button ytp-panel-back-button"></button>\n                  </div>\n                  <span class="ytp-panel-title">${b("defaultSubtitles")}</span>\n                </div>\n                <div class="ytp-panel-menu" role="menu" id="languageList">${l}</div>\n              </div>`),L(i,n),m.querySelector("#languageList").addEventListener("click",(function(e){if(e.target===this)return;const o={langCode:e.target.dataset.lang,langName:e.target.textContent.trim()};if(chrome.storage.sync.set(o),t.includes(o.langCode)){const e=t.filter((e=>e!==o.langCode)),n=[].concat(o.langCode,e);chrome.storage.sync.set({recentLang:n})}else{const e=[].concat(o.langCode,t).slice(0,6);chrome.storage.sync.set({recentLang:e})}[...this.children].forEach((e=>e.removeAttribute("aria-checked"))),e.target.parentElement.setAttribute("aria-checked",!0),v.querySelector("#language-button .ytp-menuitem-content").textContent=o.langName,f(i,n,(()=>window.postMessage({source:"ext",type:"restartSubtitles"})))}))}};window.addEventListener("message",o)}))})),v.querySelector("#dubbing-settings").addEventListener("click",(()=>{chrome.storage.sync.get(["voiceCode","voiceName"],(({voiceCode:e,voiceName:t})=>{const n=m.style.getPropertyValue("height");let i=Math.round(.7*y.querySelector(".html5-video-player").offsetHeight);i>416&&(i=416),window.postMessage({source:"ext",type:"requestTranslationList"});const o=({data:t})=>{if("web"===t.source&&"responseTranslationList"===t.type){window.removeEventListener("message",o);const t=["a","b","c"].map((t=>`<div class="ytp-menuitem" role="menuitemradio" ${e===t?'aria-checked="true"':""}>\n                      <div class="ytp-menuitem-label" data-voicecode="${t}">${t}</div>\n                  </div>`)).join("");m.insertAdjacentHTML("beforeend",`<div class="ytp-panel ytp-panel-animate-forward" id="forward" style="min-width: 250px; height: ${i}px;">\n                <div class="ytp-panel-header">\n                  <button class="ytp-button ytp-panel-title">${b("dubbingSettings")}</button>\n                </div>\n                <div class="ytp-panel-menu" role="menu" id="voiceList">${t}</div>\n              </div>`),L(i,n),m.querySelector("#voiceList").addEventListener("click",(function(e){if(e.target===this)return;const t={voiceCode:e.target.dataset.voicecode,voiceName:e.target.textContent.trim()};chrome.storage.sync.set(t),[...this.children].forEach((e=>e.removeAttribute("aria-checked"))),e.target.parentElement.setAttribute("aria-checked",!0),v.querySelector("#dubbing-settings .ytp-menuitem-content").textContent=t.voiceName,f(i,n)}))}};window.addEventListener("message",o)}))})),m.querySelector("#subtitle-download").addEventListener("click",(async()=>{"false"===y.querySelector(".ytp-subtitles-button").getAttribute("aria-pressed")&&window.postMessage({source:"ext",type:"openSubtitle"});const e=m.style.getPropertyValue("height");let t=Math.round(.7*y.querySelector(".html5-video-player").offsetHeight);t>416&&(t=416),m.insertAdjacentHTML("beforeend",`<div class="ytp-panel ytp-panel-animate-forward" id="forward" style="min-width: 250px; height: ${t}px;">\n          <div class="ytp-panel-header">\n            <div class="ytp-panel-back-button-container">\n              <button class="ytp-button ytp-panel-back-button"></button>\n            </div>\n            <span class="ytp-panel-title">${b("subtitleDownload")}</span>\n          </div>\n          <div class="ytp-panel-menu" role="menu" id="downloadList"></div>\n        </div>`),L(t,e);const n=m.querySelector("#downloadList"),i=setTimeout((()=>{n.innerHTML='<div class="ytp-menuitem" role="menuitemradio" style="pointer-events: none;">\n          <div class="ytp-menuitem-label" style="position: relative;">\n            <div class="ytp-spinner" style="width: 45px;top: 100%; opacity: 0.8;">\n              <div class="ytp-spinner-container">\n                <div class="ytp-spinner-rotator">\n                  <div class="ytp-spinner-left"><div class="ytp-spinner-circle" style="border-width: 4px"></div></div>\n                  <div class="ytp-spinner-right"><div class="ytp-spinner-circle" style="border-width: 4px"></div></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>'}),300),o=p?window.location.pathname.split("/")[2]:new URLSearchParams(location.search).get("v"),s=await requestSubtitleList(o).catch((()=>!1));if(window.clearTimeout(i),!s)return void(n.innerHTML=`\n        <div class="ytp-menuitem" role="menuitemradio" aria-disabled="true" style="user-select: text;">\n          <div class="ytp-menuitem-label">${b("goBack")}</div>\n        </div>`);const{captionTracks:a,translationLanguages:r}=s.captions.playerCaptionsTracklistRenderer,l=a.map((({baseUrl:e,name:t})=>`\n          <div class="ytp-menuitem" role="menuitemradio">\n            <div class="ytp-menuitem-label" data-baseurl="${e}">${t.simpleText}</div>\n          </div>`)).join(""),c=await new Promise((e=>chrome.storage.sync.get("recentDown",(({recentDown:t})=>e(t)))));let d=[];const u=r.reduce(((e,{languageCode:t,languageName:n})=>{const i=c.indexOf(t);return-1!==i?(d[i]=`\n            <div class="ytp-menuitem" role="menuitemradio">\n              <div class="ytp-menuitem-label" data-tlang="${t}">${n.simpleText}</div>\n            </div>`,e):e.concat(`<div class="ytp-menuitem" role="menuitemradio">\n              <div class="ytp-menuitem-label" data-tlang="${t}">${n.simpleText}</div>\n            </div>`)}),[]),g=d.concat(u).join("");n.innerHTML=`\n      <div class="ytp-menuitem" role="menuitemradio" style="background-color: #ffffff42; pointer-events: none;">\n        <div class="ytp-menuitem-label" style="padding-left: 20px;">\n          ${b("videoSubtitles")}\n        </div>\n      </div>\n      ${l}\n      <div class="ytp-menuitem" role="menuitemradio" style="background-color: #ffffff42; pointer-events: none;">\n        <div class="ytp-menuitem-label" style="padding-left: 20px;">\n          ${b("autoTranslate")}\n        </div>\n      </div>\n      ${g}`;let v=null;n.addEventListener("click",(function(e){if(e.target===this)return;const t=e.target.dataset.tlang;if(v===e.target.parentElement.nextElementSibling){const e=v.style.getPropertyValue("height");return void v.style.setProperty("height","0px"===e?(t?140:70)+"px":"0")}v&&v.style.setProperty("height","0");const i=s.microformat.playerMicroformatRenderer.title.simpleText,o=e.target.textContent.trim();let r="",l="",c="",d=[{typeName:".txt",type:"txt"},{typeName:".srt",type:"srt"},{typeName:`.txt (${b("bilingual")})`,type:"txt2"},{typeName:`.srt (${b("bilingual")})`,type:"srt2"}];if(t){const e=new URL(subtitleRequestXhrUrl),n=e.searchParams.get("lang"),i=!!e.searchParams.get("kind"),{baseUrl:o,name:s}=a.find((e=>e.languageCode===n&&!!e.kind===i));r=s.simpleText,l=o,c=`${l}&tlang=${t}`}else c=e.target.dataset.baseurl,d=d.slice(0,2);const p=d.map((e=>`\n          <div class="ytp-menuitem" role="menuitemradio" style="display: flex; align-items: center; height: 35px; position: relative;" data-type="${e.type}">\n            <div class="ytp-menuitem-label" style="padding-left: 50px;" >\n              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M12 6L10.9425 4.9425L6.75 9.1275V0H5.25V9.1275L1.065 4.935L0 6L6 12L12 6Z" fill="white"/>\n              </svg>\n              <span style="font-size: 14px; margin-left: 6px; vertical-align: bottom;">${e.typeName}</span>\n            </div>\n          </div>`)).join("");e.target.parentElement.insertAdjacentHTML("afterend",`<div class="downlist" style="display: flex; justify-content: center; flex-direction: column; height: 0; overflow: hidden; transition: height 200ms;">\n            ${p}\n          </div>`),n.querySelectorAll(".downlist").forEach((e=>e.addEventListener("click",(e=>e.stopPropagation()))));const u=async function(){const e=setTimeout((()=>this.insertAdjacentHTML("beforeend",'<div class="ytp-spinner downloadOptions" style="width: 20px; opacity: 0.8; left: 100%;">\n                  <div class="ytp-spinner-container">\n                    <div class="ytp-spinner-rotator">\n                      <div class="ytp-spinner-left"><div class="ytp-spinner-circle" style="border-width: 3px"></div></div>\n                      <div class="ytp-spinner-right"><div class="ytp-spinner-circle" style="border-width: 3px"></div></div>\n                    </div>\n                  </div>\n                </div>')),300),s=(t,i)=>{const o=document.createElement("a");o.href=window.URL.createObjectURL(new Blob([t],{type:"text/plain"})),o.download=i,o.click(),window.URL.revokeObjectURL(o.href),window.clearTimeout(e),n.querySelectorAll(".ytp-spinner.downloadOptions").forEach((e=>e.remove()))},d=e=>new Date(e).toISOString().slice(11,-1).replace(".",",");if(t){const e=await new Promise((e=>chrome.storage.sync.get("recentDown",(({recentDown:t})=>e(t)))));if(e.includes(t)){const n=e.filter((e=>e!==t)),i=[].concat(t,n);chrome.storage.sync.set({recentDown:i})}else{const n=[].concat(t,e).slice(0,6);chrome.storage.sync.set({recentDown:n})}}const p=new URL(c).searchParams.get("lang");switch(this.dataset.type){case"txt":await subtitlesHandler(c,t||p).then((e=>{const t=e.reduce(((e,t)=>t.segs.trim()?e.concat(t.segs):e),[]).join("\n\n");s(t,`${i} - ${o}.txt`)})).catch((()=>errorBackHandler(1)));break;case"srt":await subtitlesHandler(c,t||p).then((e=>{const t=e.reduce(((e,t)=>t.segs.trim()?e.concat(`${e.length+1}\n${d(t.tStartMs)} --\x3e ${d(t.tStartMs+t.dDurationMs)}\n${t.segs}`):e),[]).join("\n\n");s(t,`${i} - ${o}.srt`)})).catch((()=>errorBackHandler(1)));break;case"txt2":chrome.storage.sync.get("dualSubtitlesStyle",(({dualSubtitlesStyle:e})=>{const n=a.find((e=>t===standardCode(e.languageCode)&&!e.kind));n?Promise.all([subtitlesHandler(l,p),subtitlesHandler(n.baseUrl,t)]).then((([n,a])=>{if(n.length===a.length){const t=(t,n)=>1===e.one.rowStart?`${t.segs}\n${a[n].segs}`:`${a[n].segs}\n${t.segs}`,l=n.reduce(((e,n,i)=>n.segs.trim()?e.concat(`${t(n,i)}`):e),[]).join("\n\n");s(l,`${i} - ${r} ✔ ${o}(${b("bilingual")}).txt`)}else subtitlesHandler(c,t).then((t=>{const a=n.reduce(((n,i,o)=>i.segs.trim()?n.concat(`${((n,i)=>1===e.one.rowStart?`${n.segs}\n${t[i].segs}`:`${t[i].segs}\n${n.segs}`)(i,o)}`):n),[]).join("\n\n");s(a,`${i} - ${r} 🡲 ${o}(${b("bilingual")}).txt`)}))})):Promise.all([subtitlesHandler(l,p),subtitlesHandler(c,t)]).then((([t,n])=>{const a=t.reduce(((t,i,o)=>i.segs.trim()?t.concat(`${((t,i)=>1===e.one.rowStart?`${t.segs}\n${n[i].segs}`:`${n[i].segs}\n${t.segs}`)(i,o)}`):t),[]).join("\n\n");s(a,`${i} - ${r} 🡲 ${o}(${b("bilingual")}).txt`)})).catch((()=>errorBackHandler(1)))}));break;case"srt2":chrome.storage.sync.get("dualSubtitlesStyle",(({dualSubtitlesStyle:e})=>{const n=a.find((e=>t===standardCode(e.languageCode)&&!e.kind));n?Promise.all([subtitlesHandler(l,p),subtitlesHandler(n.baseUrl,t)]).then((([n,a])=>{if(n.length===a.length){const t=(t,n)=>1===e.one.rowStart?`${t.segs}\n${a[n].segs}`:`${a[n].segs}\n${t.segs}`,l=n.reduce(((e,n,i)=>n.segs.trim()||a[i].segs.trim()?e.concat(`${e.length+1}\n${d(n.tStartMs)} --\x3e ${d(n.tStartMs+n.dDurationMs)}\n${t(n,i)}`):e),[]).join("\n\n");s(l,`${i} - ${r} ✔ ${o}(${b("bilingual")}).srt`)}else subtitlesHandler(c,t).then((t=>{const a=n.reduce(((n,i,o)=>i.segs.trim()||t[o].segs.trim()?n.concat(`${n.length+1}\n${d(i.tStartMs)} --\x3e ${d(i.tStartMs+i.dDurationMs)}\n${((n,i)=>1===e.one.rowStart?`${n.segs}\n${t[i].segs}`:`${t[i].segs}\n${n.segs}`)(i,o)}`):n),[]).join("\n\n");s(a,`${i} - ${r} 🡲 ${o}(${b("bilingual")}).srt`)}))})):Promise.all([subtitlesHandler(l,p),subtitlesHandler(c,t)]).then((([t,n])=>{const a=t.reduce(((t,i,o)=>i.segs.trim()||n[o].segs.trim()?t.concat(`${t.length+1}\n${d(i.tStartMs)} --\x3e ${d(i.tStartMs+i.dDurationMs)}\n${((t,i)=>1===e.one.rowStart?`${t.segs}\n${n[i].segs}`:`${n[i].segs}\n${t.segs}`)(i,o)}`):t),[]).join("\n\n");s(a,`${i} - ${r} 🡲 ${o}(${b("bilingual")}).srt`)})).catch((()=>errorBackHandler(1)))}))}};setTimeout((()=>{v=e.target.parentElement.nextElementSibling,v.style.setProperty("height",35*d.length+"px"),[...v.children].forEach((e=>e.addEventListener("click",u)))}),8)}))})),(document.head||document.documentElement).insertAdjacentHTML("afterbegin",`<style id="captionPosition">\n        #ytp-caption-window-container .caption-window:not([lang]) {\n          ${+a.left.replace("%","")<30?"margin-left: 0 !important;":""}\n          top: ${a.top} !important;\n          left: ${a.left} !important;\n          bottom: ${a.bottom} !important;\n          right: ${a.right} !important;\n        }\n      </style>`);const $=y.querySelector(".ytp-subtitles-button");$&&$.addEventListener("mouseup",(()=>{setTimeout((()=>{const e=$.getAttribute("aria-pressed");chrome.storage.sync.set({openSubtitle:e}),window.openSubtitle=e}),200)}));const x=()=>{window.postMessage({source:"ext",type:"enterStateToggle",text:!1}),["click","blur"].forEach((e=>window.removeEventListener(e,x)))};window.addEventListener("message",(({data:e})=>{"web"===e.source&&"responseQuality"===e.type&&(chrome.storage.sync.set({quality:e.text}),window.postMessage({source:"ext",type:"enterStateToggle",text:!1,quality:e.text}),["click","blur"].forEach((e=>window.removeEventListener(e,x))))}));const S=e=>{e.target!==e.currentTarget&&window.postMessage({source:"ext",type:"onQualityChange"})},q=e=>{e.target!==e.currentTarget&&(window.postMessage({source:"ext",type:"enterStateToggle",text:!0}),["click","blur"].forEach((e=>window.addEventListener(e,x,{once:!0}))))},k=()=>{setTimeout((()=>{const e=m.querySelector(".ytp-quality-menu .ytp-panel-menu");e&&(e.addEventListener("mousedown",q),e.addEventListener("click",S))}),180)};w.addEventListener("click",(()=>{const e=v.querySelectorAll(".ytp-menuitem:not([id])"),t=e[e.length-1];if(t){t.addEventListener("click",k,{once:!0}),t.classList.add("quality-button");const e=t.querySelector(".ytp-menuitem-content"),n=t.querySelector("#qualityIcon");if(e&&!n){const t=document.createElement("div");t.id="qualityIcon",t.dataset.lock=d,t.addEventListener("click",(e=>{e.stopPropagation(),d="true"!==t.dataset.lock,document.querySelector("#qualityUnlock").disabled=d,chrome.storage.sync.set({qualityLock:d}),t.dataset.lock=d,document.querySelector("#qualityLockTips")||(()=>{const e=chrome.i18n.getMessage("lockTips");document.body.insertAdjacentHTML("beforeend",`<div id="qualityLockTips" style="box-sizing:border-box;min-width:300px;white-space:nowrap;background:#202124;border-radius:4px;padding:18px;display:flex;justify-content:space-between;align-items:center;font-family:Roboto,'Microsoft YaHei UI','Microsoft YaHei','Helvetica Neue Light','Helvetica Neue',Helvetica,Arial,sans-serif;box-shadow:2px 4px 5px #00000042;z-index:3000;position:fixed;left:0;bottom:-18px;opacity:0;margin:12px;transition:all .3s"><style>#qualityLockTips #close:hover{background:#3fc4ff1a}</style><div style="color:#fff;font-size:16px">${e}</div><div id="close" style="user-select:none;padding:8px;border-radius:4px;display:inline-flex;justify-content:center;align-items:center;transition:background 160ms;cursor:pointer"><svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 1.30929L11.6907 0L6.5 5.19071L1.30929 0L0 1.30929L5.19071 6.5L0 11.6907L1.30929 13L6.5 7.80929L11.6907 13L13 11.6907L7.80929 6.5L13 1.30929Z" fill="#4387ff"/></svg></div></div>`),setTimeout((()=>{const e=document.querySelector("#qualityLockTips");e.style.setProperty("bottom","0"),e.style.setProperty("opacity","1"),e.querySelector("#close").addEventListener("click",(()=>{e.style.setProperty("bottom","-18px"),e.style.setProperty("opacity","0"),setTimeout((()=>e.remove()),500)}))}),30)})()})),e.append(t)}d&&(document.querySelector("#qualityUnlock").disabled=!0)}}));const E=(e,t)=>{let n=!1;const i=document.querySelector(`${t} .html5-video-player`),o=i.getPreferredQuality();window.addEventListener("message",(({data:t})=>{"ext"===t.source&&"enterStateToggle"===t.type&&(n=t.text,t.quality&&(e=t.quality))})),e!==o&&i.getAvailableQualityLevels().includes(e)&&i.setPlaybackQualityRange(e),i.addEventListener("onPlaybackQualityChange",(t=>{n||e===t||setTimeout((()=>{i.getAvailableQualityLevels().includes(e)&&i.setPlaybackQualityRange(e)}),200)}))};if(p)y.querySelector("video").addEventListener("play",(()=>{setTimeout((()=>{const e=y.querySelector("#ytp-caption-window-container");if(e){const t=y.querySelector(".ytp-subtitles-button");t.getAttribute("aria-pressed")!==r&&t.click(),e.addEventListener("mousedown",(e=>{window.getSelection().removeAllRanges(),0===e.button&&(document.querySelector("#captionPosition").disabled=!0)})),e.addEventListener("dragstart",(t=>{t.preventDefault();const n=e.querySelector(".caption-window"),i=()=>{if(n.offsetLeft<=20){const t=(Math.abs(parseInt(n.style.marginLeft,10))+20)/e.offsetWidth;n.style.left=100*t+"%"}};window.addEventListener("mousemove",i),window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",i);const t=e.querySelector(".caption-window"),n=["left","right","top","bottom"].reduce(((e,n)=>({...e,[n]:t.style[n]?t.style[n]:"auto"})),{});chrome.storage.sync.set({position:n}),document.querySelector("#captionPosition").textContent=`\n                        #ytp-caption-window-container .caption-window:not([lang]) {\n                          ${+n.left.replace("%","")<30?"margin-left: 0 !important;":""}\n                          top: ${n.top} !important;\n                          left: ${n.left} !important;\n                          bottom: ${n.bottom} !important;\n                          right: ${n.right} !important;\n                        }`}),{once:!0})}));const n=t=>{t.stopPropagation(),0===t.button&&(window.getSelection().removeAllRanges(),e.querySelector(".caption-window").setAttribute("draggable",!1),window.addEventListener("mouseup",(()=>{e.querySelector(".caption-window").setAttribute("draggable",!0)}),{once:!0}))};e.addEventListener("contextmenu",(e=>e.stopPropagation())),e.addEventListener("mouseenter",(()=>{e.querySelectorAll(".caption-visual-line .ytp-caption-segment").forEach((e=>{e.addEventListener("mousedown",n)}));const t=e.querySelector(".caption-window"),i=t.offsetLeft,o=t.offsetTop,s=document.querySelector("#subtitleHandle");i<=6&&o<=22?(s.disabled=!1,s.textContent=`\n                  #ytp-caption-window-container .caption-window:not([lang])::before {\n                    left: ${6+Math.abs(i)}px;\n                    top: 100%;\n                    bottom: auto;\n                  }\n                  `):o<=22?(s.disabled=!1,s.textContent="\n                  #ytp-caption-window-container .caption-window:not([lang])::before {\n                    top: 100%;\n                    bottom: auto;\n                  }\n                  "):i<=6?(s.disabled=!1,s.textContent=`\n                  #ytp-caption-window-container .caption-window:not([lang])::before {\n                    left: ${6+Math.abs(i)}px;\n                  }\n                  `):s.disabled||(s.disabled=!0)}))}}),300),d&&setTimeout((()=>{const e=document.createElement("script");e.textContent=`(${E.toString()})('${c}', '${u}')`,(document.head||document.documentElement).append(e),e.remove()}),1200)}),{once:!0});else{const e=y.querySelector('.ytp-button[data-tooltip-target-id="ytp-autonav-toggle-button"]');e&&(e.addEventListener("mouseup",(()=>{setTimeout((()=>{const t=e.querySelector(".ytp-autonav-toggle-button").getAttribute("aria-checked");chrome.storage.sync.set({autoPlay:t})}),200)})),setTimeout((()=>{const t=e.querySelector(".ytp-autonav-toggle-button").getAttribute("aria-checked");l!==t&&e.click()}),600)),d&&setTimeout((()=>{const e=document.createElement("script");e.textContent=`(${E.toString()})('${c}', '${u}')`,(document.head||document.documentElement).append(e),e.remove()}),1200)}};chrome.storage.sync.get(["single","langCode","langName","dubbing","voiceCode","voiceName","position","openSubtitle","autoPlay","quality","qualityLock"],(t=>{if(window.openSubtitle=t.openSubtitle,window.location.pathname.includes("/embed/"))"0"!==new URLSearchParams(window.location.search).get("controls")&&e(t,!0);else{const n=setInterval((()=>{document.querySelector("#ytd-player .ytp-settings-menu .ytp-panel .ytp-panel-menu")&&(clearInterval(n),e(t,!1))}),500)}}))}if(!window.location.pathname.includes("/embed/")){const e=setInterval((()=>{const t=document.querySelector("#ytd-player #ytp-caption-window-container");if(t&&(clearInterval(e),"true"!==t.dataset.listenevent)){t.dataset.listenevent="true";const e=document.querySelector("#ytd-player .ytp-subtitles-button");e.getAttribute("aria-pressed")!==window.openSubtitle&&e.click();const n=document.querySelector("#captionPosition");n&&n.disabled&&(n.disabled=!1),t.addEventListener("mousedown",(e=>{window.getSelection().removeAllRanges(),0===e.button&&(document.querySelector("#captionPosition").disabled=!0)})),t.addEventListener("dragstart",(e=>{e.preventDefault();const n=t.querySelector(".caption-window"),i=()=>{if(n.offsetLeft<=20){const e=(Math.abs(parseInt(n.style.marginLeft,10))+20)/t.offsetWidth;n.style.left=100*e+"%"}};window.addEventListener("mousemove",i),window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",i);const e=t.querySelector(".caption-window"),n=["left","right","top","bottom"].reduce(((t,n)=>({...t,[n]:e.style[n]?e.style[n]:"auto"})),{});chrome.storage.sync.set({position:n}),document.querySelector("#captionPosition").textContent=`\n                #ytp-caption-window-container .caption-window:not([lang]) {\n                  ${+n.left.replace("%","")<30?"margin-left: 0 !important;":""}\n                  top: ${n.top} !important;\n                  left: ${n.left} !important;\n                  bottom: ${n.bottom} !important;\n                  right: ${n.right} !important;\n                }`}),{once:!0})}));const i=e=>{e.stopPropagation(),0===e.button&&(window.getSelection().removeAllRanges(),t.querySelector(".caption-window").setAttribute("draggable",!1),window.addEventListener("mouseup",(()=>{t.querySelector(".caption-window").setAttribute("draggable",!0)}),{once:!0}))};t.addEventListener("contextmenu",(e=>e.stopPropagation())),t.addEventListener("mouseenter",(()=>{t.querySelectorAll(".caption-visual-line .ytp-caption-segment").forEach((e=>{e.addEventListener("mousedown",i)}));const e=t.querySelector(".caption-window"),n=e.offsetLeft,o=e.offsetTop,s=document.querySelector("#subtitleHandle");n<=6&&o<=22?(s.disabled=!1,s.textContent=`\n            #ytp-caption-window-container .caption-window:not([lang])::before {\n              left: ${6+Math.abs(n)}px;\n              top: 100%;\n              bottom: auto;\n            }\n            `):o<=22?(s.disabled=!1,s.textContent="\n            #ytp-caption-window-container .caption-window:not([lang])::before {\n              top: 100%;\n              bottom: auto;\n            }\n            "):n<=6?(s.disabled=!1,s.textContent=`\n            #ytp-caption-window-container .caption-window:not([lang])::before {\n              left: ${6+Math.abs(n)}px;\n            }\n            `):s.disabled||(s.disabled=!0)}))}}),1200)}